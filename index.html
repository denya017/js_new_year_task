<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket</title>
  <style>
    body {
      max-width: 70vw;
      margin-left: auto;
      margin-right: auto;
    }

    .level-list {
      display: flex;
      justify-content: space-between;
      margin-bottom: 50px;
    }

    .level-list__item {
      box-sizing: border-box;
    }

    .level-state {
      width: 200px;
      height: 200px;
      background-color: inherit;
    }

    .token {
      display: flex;
      flex-direction: column;
      align-items: center;
      word-break: break-all;
    }
  </style>
</head>
<body>
  <div class="level-list">
    <div class="level-list__item"></div>
    <div class="level-list__item"></div>
    <div class="level-list__item"></div>
    <div class="level-list__item"></div>
  </div>
</body>

<script>
  const socket = new WebSocket('ws://vps.yojji.io', 'denis_tarasenko');
  let levelsState = [false, false, false, false];

  drawLevelsState();

  socket.onopen = () => console.log('opened');
  socket.onclose = () => console.log('close');

  socket.onmessage = (event) => {
    const data = JSON.parse(event.data);

    console.log(data);
    drawLevelsState();

    if (data.token) {
      socket.close();
      
      const div = document.createElement('div');
      div.className = 'token';
      div.innerHTML = `
        <img src="https://www.nicepng.com/png/full/214-2144268_jackpot-png.png" alt="jackpot">
        <p>Your token: ${data.token}</p>
      `;
      document.body.appendChild(div);

      return;
    };

    if (data.newState) {
      levelsState = levelsState.map(item => !item);  
    };

    if (levelsState.every(item => item)) {
      socket.send(JSON.stringify({
        action: "powerOff",
        stateId: data.stateId
      }));
    }

    if (data.pulled >= 0) {
      levelsState[data.pulled] = !levelsState[data.pulled];

      socket.send(JSON.stringify({
          action: "check",
          "lever1": 0,
          "lever2": data.pulled,
          stateId: data.stateId
          }));
    }

    if (data.action) {
      levelsState[data.lever2] = data.same ? levelsState[0] : !levelsState[0];
    }
  }

  function drawLevelsState() {
    const levelsList = document.querySelectorAll('.level-list__item');

    for (const i in levelsList) {
      levelsList[i].innerHTML = levelsState[i] ?
      `<img src="https://media.istockphoto.com/vectors/lucky-seven-red-sign-icon-gambling-casino-slot-machine-element-7-vector-id1252749300?k=20&m=1252749300&s=170667a&w=0&h=5X8Cq7oWIR1FFNY_RzjAIEXipAXmox9q--MIXTWwQo0=" class="level-state" alt="true">` : 
      `<img src="https://i.pinimg.com/originals/94/1f/db/941fdb9a311ed790b73fad62d4cc9355.jpg" class="level-state" alt="false">`;
    }
}
</script>
</html>